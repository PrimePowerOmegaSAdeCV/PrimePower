<?xml version="1.0" encoding="UTF-8"?>
<odoo>

    <template id="report_assets_common_inherit_pp" inherit_id="web.report_assets_common">
        <xpath expr="//link[@href='/web/static/src/less/report.less']" position="after">
            <link href="/pp_sale/static/src/less/so_report_style.less" rel="stylesheet"/>
        </xpath>
    </template>

    <template id="external_layout_custom_pp">
        <div class="header o_pp_header">
            <div class="pull-right">
                <h3 class="mt0 text-right" t-field="company.report_header"/>
            </div>
            <img t-if="company.logo" t-att-src="'data:image/png;base64,%s' % to_text(company.logo)" class="pull-left"/>
            <div class="pull-right company_address">
                <div class="text-center">
                    <!--todo modify t-if so that there is no awkward empty space?-->
                    <p id="pp-top-line">
                        <span t-field="company.name"/>, RFC: <span t-field="company.partner_id.vat"/>
                    </p>
                    <p>
                        <span t-field="company.street_name"/><span t-esc="' '"/><span t-field="company.street_number"/>
                    </p>
                    <p>
                        <span t-field="company.l10n_mx_edi_colony"/>, <span t-field="company.l10n_mx_edi_locality"/>, <span t-field="company.zip"/>, <span t-field="company.state_id.code"/>, <span t-field="company.country_id"/>
                    </p>
                    <p>
                        <span t-field="company.phone"/>, <span t-field="company.website"/>
                    </p>
                </div>
            </div>
            <div class="clearfix mb8"/>
        </div>

        <div class="article o_report_layout_pp">
            <t t-raw="0"/>
        </div>

        <div class="footer o_pp_footer">
            <div class="text-center">
                <div t-if="company.report_footer" t-field="company.report_footer"/>
                <img t-if="company.report_footer_image" t-att-src="'data:image/png;base64,%s' % to_text(company.report_footer_image)"/>
                <!--<div class="text-center" t-field="company.report_footer_image" t-options="{'widget': 'image', 'style': 'height: 120px'}"/>-->
                <!-- todo: ask if they still want page number?-->
                <!--<div class="text-muted">-->
                    <!--Page:-->
                    <!--<span class="page"/>-->
                    <!--of-->
                    <!--<span class="topage"/>-->
                <!--</div>-->
            </div>
        </div>
    </template>

    <template id="external_layout_general_custom_pp">
        <!-- Multicompany -->
        <t t-if="not o and doc">
            <t t-set="o" t-value="doc"/>
        </t>

        <t t-if="o and 'company_id' in o">
            <t t-set="company" t-value="o.company_id.sudo()"/>
        </t>
        <t t-if="not o or not 'company_id' in o">
            <t t-set="company" t-value="res_company"/>
        </t>

        <t t-call="pp_sale.external_layout_custom_pp"><t t-raw="0"/></t>
    </template>


    <template id="report_saleorder_document_pp">
            <t t-call="pp_sale.external_layout_general_custom_pp">
                <t t-set="doc" t-value="doc.with_context({'lang':doc.partner_id.lang})"/>
                <div class="page">
                    <div class="oe_structure"/>

                    <!-- (1) sale order info -->
                    <div class="mb8 row">
                        <div class="col-xs-12">
                            <div id="section-title">Information: </div>
                        </div>
                    </div>
                    <div class="mb32 row" id="sale_order_informations">
                        <div class="col-xs-6">
                            <div class="row">
                                <strong class="col-xs-6">Customer:</strong>
                                <span class="col-xs-6" t-field="doc.partner_id"/>
                            </div>
                            <div class="row">
                                <t t-if="not (env.context.get('proforma', False) or is_pro_forma)">
                                    <strong class="col-xs-6" t-if="doc.state not in ['draft','sent']">Order # </strong>
                                    <strong class="col-xs-6" t-if="doc.state in ['draft','sent']">Quotation # </strong>
                                </t>
                                <t t-if="env.context.get('proforma', False) or is_pro_forma">
                                    <strong class="col-xs-6">Pro-Forma Invoice # </strong>
                                </t>
                                <span class="col-xs-6" t-field="doc.name"/>
                            </div>
                            <div class="row" t-if="doc.payment_term_id">
                                <strong class="col-xs-6">Payment Terms:</strong>
                                <span class="col-xs-6" t-field="doc.payment_term_id"/>
                            </div>
                        </div>

                        <div class="col-xs-6">
                            <div class="row" t-if="doc.contact_partner_id">
                                <strong class="col-xs-6">Contact Customer:</strong>
                                <span class="col-xs-6" t-field="doc.contact_partner_id.name"/>
                            </div>
                            <div class="row" t-if="doc.validity_date and doc.state in ['draft', 'sent']">
                                <strong class="col-xs-6">Expiration Date:</strong>
                                <span class="col-xs-6" t-field="doc.validity_date"/>
                            </div>
                            <!--<div class="row" t-if="doc.lab_prices">-->
                                <!--<strong class="col-xs-6">L.A.B Prices:</strong>-->
                                <!--<span class="col-xs-6" t-field="doc.lab_prices"/>-->
                            <!--</div>-->
                            <div class="row" t-if="doc.incoterm">
                                <strong class="col-xs-6">Incoterms:</strong>
                                <span class="col-xs-6" t-field="doc.incoterm"/>
                            </div>
                            <div class="row" t-if="doc.pricelist_id and doc.pricelist_id.currency_id">
                                <strong class="col-xs-6">Currency:</strong>
                                <span class="col-xs-6" t-field="doc.pricelist_id.currency_id.name"/>
                            </div>
                        </div>
                    </div>

                    <!-- (2) Texto Cotizacion -->
                    <t t-if="doc.company_id.text_quote">
                        <div class="mb8 row">
                            <div class="col-xs-12">
                                <div id="section-title">Text Quote: </div>
                            </div>
                        </div>

                        <div class="mb32 row" id="company_text_quote">
                            <div class="col-xs-12">
                                <p t-field="doc.company_id.text_quote"/>
                            </div>
                        </div>
                    </t>

                    <!-- (3) Cotizacion de Productos: lines I'm guessing -->

                    <div class="row mb8">
                        <div class="col-xs-12">
                            <div id="section-title">Order Lines: </div>
                        </div>
                    </div>

                    <!-- Is there a discount on at least one line? -->
                    <t t-set="display_discount" t-value="any([l.discount for l in doc.order_line])"/>

                    <t t-foreach="doc.order_lines_layouted()" t-as="page">
                        <table class="table table-condensed">
                            <thead>
                                <tr>
                                    <th>Internal Reference</th>
                                    <!--  Descipcion Para Clientes -->
                                    <th>Description</th>
                                    <!-- Tiempo de Entrega -->
                                    <th>Delivery Time</th>
                                    <!--<th>Description</th>-->
                                    <th class="text-right">Unit Price</th>
                                    <th class="text-right">Quantity</th>
                                    <th t-if="display_discount" class="text-right" groups="sale.group_discount_per_so_line">Disc.(%)</th>
                                    <!--<th class="text-right">Taxes</th>-->
                                    <th class="text-right" groups="sale.group_show_price_subtotal">Amount</th>
                                    <th class="text-right price_tax_included" groups="sale.group_show_price_total">Total Price</th>
                                </tr>
                           </thead>
                           <tbody class="sale_tbody">
                                <t t-foreach="page" t-as="layout_category">

                                    <t t-if="layout_category_size &gt; 1 or page_size &gt; 1" groups="sale.group_sale_layout">
                                        <tr class="active">
                                            <td colspan="7" style="font-weight: bold; border-bottom: 1px solid black;">&amp;bull;
                                                <t t-esc="layout_category['name']"/>
                                            </td>
                                        </tr>
                                    </t>

                                    <!-- Lines associated -->
                                    <t t-foreach="layout_category['lines']" t-as="l">
                                        <tr>
                                            <td><span t-field="l.product_id.default_code"/></td>
                                            <td><span t-field="l.product_id.description_sale"/></td>
                                            <td><span t-field="l.delivery_time_id"/></td>
                                            <!--<td><span t-field="l.name"/></td>-->
                                            <td class="text-right">
                                                <span t-field="l.price_unit"/>
                                            </td>
                                            <td class="text-right">
                                                <span t-field="l.product_uom_qty"/>
                                                <span t-field="l.product_uom" groups="product.group_uom"/>
                                            </td>

                                            <td t-if="display_discount" class="text-right" groups="sale.group_discount_per_so_line">
                                                <span t-field="l.discount"/>
                                            </td>
                                            <!--<td class="text-right">-->
                                                <!--<span t-esc="', '.join(map(lambda x: (x.description or x.name), l.tax_id))"/>-->
                                            <!--</td>-->
                                            <td class="text-right" groups="sale.group_show_price_subtotal">
                                                <span t-field="l.price_subtotal" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: doc.pricelist_id.currency_id}"/>
                                            </td>
                                            <td class="text-right" groups="sale.group_show_price_total">
                                                <span t-field="l.price_total" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: doc.pricelist_id.currency_id}"/>
                                            </td>
                                        </tr>
                                    </t>

                                    <t t-if="(layout_category_size &gt; 1 or page_size &gt; 1) and layout_category['subtotal']" groups="sale.group_sale_layout">
                                        <tr class="text-right">
                                            <td colspan="6">
                                                <strong>Subtotal: </strong>
                                                <t t-set="subtotal" t-value="sum(line.price_subtotal for line in layout_category['lines'])"/>
                                                <span t-esc="subtotal" t-options="{'widget': 'monetary', 'display_currency': doc.pricelist_id.currency_id}"/>
                                            </td>
                                        </tr>
                                    </t>

                                </t>
                            </tbody>
                        </table>

                        <t t-if="page_index &lt; page_size - 1" groups="sale.group_sale_layout">
                            <p style="page-break-before:always;"> </p>
                        </t>
                    </t>
                    <div class="clearfix">
                        <table class="table table-condensed">
                            <tr style="background-color:#d3d9de;">
                                <td>Terms and Conditions</td>
                            </tr>
                            <tr>
                                <td>
                                    <p t-field="doc.note"/>
                                </td>
                            </tr>
                        </table>
                    </div>
                    <div class="clearfix">
                        <div class="row" name="total">
                            <div class="col-xs-4 pull-right">
                                <table class="table table-condensed" style="min-width: 200px;max-width: 350px;">
                                    <tr class="border-black" style="border-bottom:1px solid #dddddd;">
                                        <td><strong>Subtotal</strong></td>
                                        <td class="text-right">
                                            <span t-field="doc.amount_untaxed" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: doc.pricelist_id.currency_id}"/>
                                        </td>
                                    </tr>
                                    <t t-foreach="doc._get_tax_amount_by_group()" t-as="amount_by_group">
                                        <tr style="border-bottom:1px solid #dddddd;">
                                            <t t-if="amount_by_group[3] == 1 and doc.amount_untaxed == amount_by_group[2]">
                                                <td>
                                                    <span t-esc="amount_by_group[0]"/>
                                                    <span>&amp;nbsp;<span>on</span>&amp;nbsp;<t t-esc="amount_by_group[2]" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: doc.pricelist_id.currency_id}"/></span>
                                                </td>
                                                <td class="text-right">
                                                    <span t-esc="amount_by_group[1]" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: doc.pricelist_id.currency_id}"/>
                                                </td>
                                            </t>
                                            <t t-else="">
                                                <td>
                                                    <span t-esc="amount_by_group[0]"/>
                                                </td>
                                                <td class="text-right">
                                                    <span t-esc="amount_by_group[1]" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: doc.pricelist_id.currency_id}"/>
                                                </td>
                                            </t>
                                        </tr>
                                    </t>
                                    <tr class="border-black">
                                        <td><strong>Total</strong></td>
                                        <td class="text-right">
                                            <span t-field="doc.amount_total" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: doc.pricelist_id.currency_id}"/>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- (4) Opcionales -->
                    <t t-if="doc.optional_product_lines_layouted()[0][0]">
                        <div class="row mb8">
                            <div class="col-xs-12">
                                <div id="section-title">Optional Products: </div>
                            </div>
                        </div>

                        <t t-set="optional_product_lines_layout" t-value="doc.optional_product_lines_layouted()[0]"/>
                        <t t-set="optional_product_images" t-value="doc.optional_product_lines_layouted()[1]"/>

                        <t t-foreach="optional_product_lines_layout" t-as="page">
                            <table class="table table-condensed">
                                <thead>
                                    <tr>
                                        <th>Internal Reference</th>
                                        <!--  Descipcion Para Clientes -->
                                        <th>Description</th>
                                        <!-- Tiempo de Entrega -->
                                        <th>Delivery Time</th>
                                        <!--<th>Description</th>-->
                                        <th class="text-right">Unit Price</th>
                                        <th class="text-right">Quantity</th>
                                        <th t-if="display_discount" class="text-right" groups="sale.group_discount_per_so_line">Disc.(%)</th>
                                        <!--<th class="text-right">Taxes</th>-->
                                        <th class="text-right" groups="sale.group_show_price_subtotal">Amount</th>
                                        <!--<th class="text-right price_tax_included" groups="sale.group_show_price_total">Total Price</th>-->
                                    </tr>
                               </thead>
                               <tbody class="sale_tbody">
                                    <t t-foreach="page" t-as="layout_category">

                                        <t t-if="layout_category_size &gt; 1 or page_size &gt; 1" groups="sale.group_sale_layout">
                                            <tr class="active">
                                                <td colspan="7" style="font-weight: bold; border-bottom: 1px solid black;">&amp;bull;
                                                    <t t-esc="layout_category['name']"/>
                                                </td>
                                            </tr>
                                        </t>

                                        <!-- Lines associated -->
                                        <t t-foreach="layout_category['optional_product_lines']" t-as="l">
                                            <tr>
                                                <td><span t-field="l.product_id.default_code"/></td>
                                                <td><span t-field="l.product_id.description_sale"/></td>
                                                <td><span t-field="l.delivery_time_id"/></td>
                                                <!--<td><span t-field="l.name"/></td>-->
                                                <td class="text-right">
                                                    <span t-field="l.price_unit"/>
                                                </td>
                                                <td class="text-right">
                                                    <span t-field="l.quantity"/>
                                                    <span t-field="l.uom_id" groups="product.group_uom"/>
                                                </td>

                                                <td t-if="display_discount" class="text-right" groups="sale.group_discount_per_so_line">
                                                    <span t-field="l.discount"/>
                                                </td>
                                                <!--<td class="text-right">-->
                                                    <!--<span t-esc="', '.join(map(lambda x: (x.description or x.name), l.tax_id))"/>-->
                                                <!--</td>-->
                                                <td class="text-right" groups="sale.group_show_price_subtotal">
                                                    <span t-esc="l.price_unit * l.quantity" t-esc-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: doc.pricelist_id.currency_id}"/>
                                                </td>
                                                <!--<td class="text-right" groups="sale.group_show_price_total">-->
                                                    <!--<span t-field="l.price_total" t-options="{&quot;widget&quot;: &quot;monetary&quot;, &quot;display_currency&quot;: doc.pricelist_id.currency_id}"/>-->
                                                <!--</td>-->
                                            </tr>
                                        </t>

                                    </t>
                                </tbody>
                            </table>

                            <t t-if="page_index &lt; page_size - 1" groups="sale.group_sale_layout">
                                <p style="page-break-before:always;"> </p>
                            </t>
                        </t>

                        <!-- (5) Imagenes de cada opcional -->
                        <t t-if="optional_product_images">
                            <div class="row mb8">
                                <div class="col-xs-12">
                                    <div id="section-title">Optional Product Images: </div>
                                </div>
                            </div>
                            <div class="row mb32 text-center" id="optional_products_images">
                                <t t-foreach="optional_product_images" t-as="p_image">
                                    <img t-att-src="'data:image/png;base64,%s' % to_text(p_image.image)" height="150px"/>
                                </t>
                            </div>
                        </t>

                    </t>
                    <!-- (6) Especificaciones Productes -->
                    <t t-set="specs" t-value="doc.order_line.mapped('product_id.product_specification_id')"/>

                    <t t-if="specs">
                        <div class="row mb8">
                            <div class="col-xs-12">
                                <div id="section-title">Product Specifications: </div>
                            </div>
                        </div>

                        <table class="table table-condensed">
                            <thead>
                                <tr>
                                    <th>Application</th>
                                    <th>Description</th>
                                </tr>
                           </thead>
                           <tbody class="sale_tbody">
                                <!-- Lines associated -->
                                <t t-foreach="specs" t-as="spec">
                                    <tr>
                                        <td><span t-field="spec.application_id.name"/></td>
                                        <td><span t-field="spec.description_id.name"/></td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>

                    </t>
                    <!-- (7) Information Relevante -->
                    <t t-if="doc.company_id.relevant_information_ids">
                        <div class="row mb8">
                            <div class="col-xs-12">
                                <div id="section-title">Relevant Information: </div>
                            </div>
                        </div>
                        <table class="table table-condensed">
                           <tbody class="sale_tbody">
                               <t t-foreach="doc.company_id.relevant_information_ids" t-as="relevant_info">
                                   <tr>
                                       <td><span t-esc="str(relevant_info_index + 1) + '. ' + relevant_info.name"/></td>
                                   </tr>
                               </t>
                            </tbody>
                        </table>
                    </t>
                    <!-- (8) Bank info -->
                    <div class="row" id="bank_information">
                        <t t-if="doc.company_id and doc.company_id.account_peso_id">
                            <div class="col-xs-6">
                                <div class="panel panel-default">
                                    <div class="panel-heading" id="section-title">
                                        <span>Account in Pesos: </span>
                                    </div>
                                    <div class="panel-body">
                                        <div class="row">
                                            <strong class="col-xs-6">Name:</strong>
                                            <span t-field="doc.company_id"/>
                                        </div>
                                        <div class="row">
                                            <strong class="col-xs-6">Account:</strong>
                                            <span t-field="doc.company_id.account_peso_id.acc_number"/>
                                        </div>
                                        <div t-if="doc.company_id.account_peso_id.transfer_code" class="row">
                                            <strong class="col-xs-6">Transfer Code:</strong>
                                            <span t-field="doc.company_id.account_peso_id.transfer_code"/>
                                        </div>
                                        <div class="row">
                                            <strong class="col-xs-6">Bank:</strong>
                                            <span t-field="doc.company_id.account_peso_id.bank_name"/>
                                        </div>
                                        <div t-if="doc.company_id.account_peso_id.bank_bic" class="row">
                                            <strong class="col-xs-6">Swift:</strong>
                                            <span t-field="doc.company_id.account_peso_id.bank_bic"/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </t>
                        <t t-if="doc.company_id and doc.company_id.account_dollar_id">
                            <div class="col-xs-6">
                                <div class="panel panel-default">
                                    <div class="panel-heading" id="section-title">
                                        <span>Account in Dollars: </span>
                                    </div>
                                    <div class="panel-body">
                                        <div class="row">
                                            <strong class="col-xs-6">Name:</strong>
                                            <span t-field="doc.company_id"/>
                                        </div>
                                        <div class="row">
                                            <strong class="col-xs-6">Account:</strong>
                                            <span t-field="doc.company_id.account_dollar_id.acc_number"/>
                                        </div>
                                        <div t-if="doc.company_id.account_dollar_id.transfer_code" class="row">
                                            <strong class="col-xs-6">Transfer Code:</strong>
                                            <span t-field="doc.company_id.account_dollar_id.transfer_code"/>
                                        </div>
                                        <div class="row">
                                            <strong class="col-xs-6">Bank:</strong>
                                            <span t-field="doc.company_id.account_dollar_id.bank_name"/>
                                        </div>
                                        <div t-if="doc.company_id.account_dollar_id.bank_bic" class="row">
                                            <strong class="col-xs-6">Swift:</strong>
                                            <span t-field="doc.company_id.account_dollar_id.bank_bic"/>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </t>
                    </div>

                    <!-- (9) Information Cliente -->

                    <div class="panel panel-default">
                        <div class="panel-heading" id="section-title">
                            <span>Client Information: </span>
                        </div>
                        <div class="panel-body">
                            <div class="col-xs-12">
                                <strong class="col-xs-6">Name:</strong>
                                <div class="col-xs-6"><span t-field="doc.partner_id"/></div>
                            </div>
                            <div class="col-xs-12">
                                <strong class="col-xs-6">VAT:</strong>
                                <div class="col-xs-6"><span t-field="doc.partner_id.vat"/></div>
                            </div>
                            <div class="col-xs-12">
                                <strong class="col-xs-6">Shipping Address:</strong>
                                <div class="col-xs-6"><span t-field="doc.partner_shipping_id" t-options="{&quot;widget&quot;: &quot;contact&quot;, &quot;fields&quot;: [&quot;address&quot;, &quot;phone&quot;], &quot;no_marker&quot;: True, &quot;phone_icons&quot;: True}"/></div>
                            </div>
                            <div class="col-xs-12">
                                <strong class="col-xs-6">Invoice Address:</strong>
                                <div class="col-xs-6"><span t-field="doc.partner_invoice_id" t-options="{&quot;widget&quot;: &quot;contact&quot;, &quot;fields&quot;: [&quot;address&quot;, &quot;phone&quot;], &quot;no_marker&quot;: True, &quot;phone_icons&quot;: True}"/></div>
                            </div>
                        </div>
                    </div>

                    <!-- (10) Image de Firm de Commercial -->
                    <t t-if="doc.user_id and doc.user_id.signature_custom">
                        <div class="row mt32 mb32">
                            <div class="col-xs-6"/>
                            <div class="col-xs-6">
                                <div id="section-title">Salesperson Signature: </div>
                                <div class="mt8">
                                    <span t-raw="doc.user_id.signature_custom"/>
                                </div>
                            </div>
                        </div>
                    </t>
                    <!--<p t-if="doc.payment_term_id.note">-->
                        <!--<span t-field="doc.payment_term_id.note"/>-->
                    <!--</p>-->
                    <!--<p id="fiscal_position_remark" t-if="doc.fiscal_position_id and doc.fiscal_position_id.note">-->
                        <!--<strong>Fiscal Position Remark:</strong>-->
                        <!--<span t-field="doc.fiscal_position_id.note"/>-->
                    <!--</p>-->
                    <div class="oe_structure"/>
                </div>
            </t>
    </template>

    <template id="report_sale_report_saleorder_inherit_pp" inherit_id="sale.report_saleorder">
        <xpath expr="//t[@t-call='sale.report_saleorder_document']" position="replace">
            <t t-call="pp_sale.report_saleorder_document_pp" t-lang="doc.partner_id.lang"/>
        </xpath>
    </template>
</odoo>
